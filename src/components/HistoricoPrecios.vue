<template>
  <ResponsiveTable
    :cols-def="colDef"
    :row-data="precios"
    :options="tableOptions"
  ></ResponsiveTable>
</template>

<script setup lang="ts">
import { computed } from 'vue'
import type Precio from '@/services/precio/models/Precio'
import { formatCurrency, pluralize } from '@/utils/utils'
import router from '@/router'
import { modelStore } from '@/main'
import Equivalencia from '@/services/equivalencia/models/Equivalencia'
import getEquivalencias from '@/services/equivalencia/getEquivalencias.service'
import ResponsiveTable, { ColDef, TableOptions } from './responsiveTable/ResponsiveTable.vue'
import { VBtn } from 'vuetify/components/VBtn'

const props = defineProps({
  editable: {
    type: Boolean,
    default: false
  },
	precios: {
		type: Array<Precio>,
		default: {},
	},
})

const tableOptions: TableOptions = {
  editable: props.editable
}

const colDef = computed(() => {
  return props.editable ? colDefBase : colDefBase.filter(col => col.field !== 'actions')
})

const colDefBase: ColDef[] = [
  { field: 'fechaCompra', header: 'Fecha compra', colType: 'text', valueGetter: ({ value }: any) => getFechaCompra(value) },
  { field: 'establecimiento', header: 'Establecimiento', colType: 'text', valueGetter: ({ value }: any) => value.nombre },
  { field: 'precio', header: 'Precio', colType: 'number', valueGetter: ({ value }: any) => formatCurrency(value) },
  { field: 'unidadesMedida', header: 'Cantidad', colType: 'html', valueGetter: ({ value }: any) => {
      let html = '<div class="cantidad-container">'
      value.forEach((medida: any) => {
        html += `<div>${medida.valor} ${pluralize(medida.nombre, medida.valor)}</div>`
      })
      html += '</div>'
      return { html }
    }
  },
  { field: 'unidadesMedida', header: 'Precio ud ref.', colType: 'html', valueGetter: (params: any) => {
      const { value, data } = params
      let html = ''
      value.forEach((medida: any) => {
        const precio = getPrecioEquivalencias.value(medida, data.precio)
        html += `<div>${precio}</div>`
      })
      return { html }
    }
  },
  {
    field: 'actions',
    header: 'Acciones',
    colType: 'actions',
    actions: [
      {
        component: VBtn,
        props: { icon: 'mdi-pencil', variant: 'text' },
        action: (data: any) => {
          onClickEdit(data)
        }
      },
      {
        component: VBtn,
        props: { icon: 'mdi-delete', variant: 'text' },
        action: (data: any) => {
          onClickDelete(data)
        }
      }
    ]
  }
]
const equivalencias = (await getEquivalencias()).data as Equivalencia[]

const getPrecioEquivalencias = computed(() => {
   return (medida: any, precio: any) => {
     const equivalencia = equivalencias.find((eq: any) => eq.from.id === medida.id)
     if (equivalencia) {
       return `${formatCurrency(precio / (medida.valor * equivalencia.factor))} ${pluralize(equivalencia.to.nombre, medida.valor * equivalencia.factor)}`
     }
     return ''
   }
})

const getFechaCompra = (value: any) => {
	return value ? new Intl.DateTimeFormat('es-ES', {
		day: "2-digit",
		month: "2-digit",
		year: "numeric",
	}).format(value) : ''
}

const onClickEdit = (precio: Precio) => {
  modelStore.setPrecio(precio)
  router.push('/precio-edicion')
}

const onClickDelete = (precio: Precio) => {
  console.log('LOG~ ~ :68 ~ onClickDelete ~ precio:', precio)
}
</script>
<style lang="scss" scoped>
  .v-card-text {
    font-size: inherit;
  }
	.wrapper {
		display: flex;
    flex-wrap: wrap;
    gap: 10px;
   .inputGroup {
      justify-content: space-between;
      align-items: center;
   }
	}
  table {
    width: 100%;
    border-collapse: collapse;
    th, td {
      padding: 8px;
      text-align: left;
    }
    th {
      background-color: #f2f2f2;
    }
  }
@media (max-width: 30em) { /* 30 x 16px = 480px */
  table {
    width: 100%;
    border-collapse: none;
    td {
      padding: 0.3em 1em;
    }
  }
  table thead {
    display: none;
  }
  table tr {
    display: flex;
    flex-direction: column;
    margin: 0.5em 0;
    margin-bottom: 1em;
    border-radius: 4px;
    border-color: rgba(var(--v-border-color), var(--v-border-opacity));
    border-style: solid;
    border-width: 0;
    box-shadow: 0px 2px 1px -1px var(--v-shadow-key-umbra-opacity, rgba(0, 0, 0, 0.2)), 0px 1px 1px 0px var(--v-shadow-key-penumbra-opacity, rgba(0, 0, 0, 0.14)), 0px 1px 3px 0px var(--v-shadow-key-ambient-opacity, rgba(0, 0, 0, 0.12));
  }
  table td[data-titulo] {
    display: flex;
    justify-content: space-between;
    // padding: 0.3em 1em;
  }
  table td:not([data-titulo]) {
    display: flex;
    justify-content: center;
    // padding: 0.3em 1em;
  }
  table td[data-titulo]::before {
    content: attr(data-titulo) ":";
    font-size: 0.8rem;
    font-weight: 500;
  }
}
</style>
